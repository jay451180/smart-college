# é¡¹ç›®ç›‘æ§å·¥ä½œæµ
# Project Monitoring Workflow for Smart College Advisor

name: é¡¹ç›®ç›‘æ§

# è§¦å‘æ¡ä»¶
on:
  schedule:
    # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ (UTC)
    - cron: '0 * * * *'
    # æ¯å¤©æ·±åº¦æ£€æŸ¥ (UTC 02:00 = åŒ—äº¬æ—¶é—´ 10:00)
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»å‹'
        required: true
        default: 'full'
        type: choice
        options:
          - quick
          - full
          - security
          - performance

# ç¯å¢ƒå˜é‡
env:
  PROJECT_ID: SMART_COLLEGE_114514
  USER_TOKEN: USER_WITH_TOKEN
  MONITOR_VERSION: "1.0.0"

jobs:
  # å¿«é€Ÿå¥åº·æ£€æŸ¥
  quick-health-check:
    name: å¿«é€Ÿå¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'quick' || github.event_name == 'schedule'
    
    outputs:
      status: ${{ steps.health.outputs.status }}
      issues: ${{ steps.health.outputs.issues }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: æ‰§è¡Œå¥åº·æ£€æŸ¥
      id: health
      run: |
        echo "ğŸ¥ æ‰§è¡Œå¿«é€Ÿå¥åº·æ£€æŸ¥..."
        issues=0
        status="healthy"
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        critical_files=(
          "index.html"
          "config.js" 
          "assets/js/main.js"
          "assets/js/firebase-service.js"
        )
        
        echo "ğŸ“ æ£€æŸ¥å…³é”®æ–‡ä»¶..."
        for file in "${critical_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file"
          else
            echo "âŒ $file ç¼ºå¤±"
            issues=$((issues + 1))
            status="unhealthy"
          fi
        done
        
        # æ£€æŸ¥é…ç½®
        echo "âš™ï¸ æ£€æŸ¥é…ç½®..."
        if grep -q "$PROJECT_ID" config.js; then
          echo "âœ… é¡¹ç›®IDé…ç½®æ­£ç¡®"
        else
          echo "âŒ é¡¹ç›®IDé…ç½®é—®é¢˜"
          issues=$((issues + 1))
          status="unhealthy"
        fi
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        echo "ğŸ“Š æ£€æŸ¥æ–‡ä»¶å¤§å°..."
        if [ -f "index.html" ]; then
          size=$(stat -c%s "index.html")
          if [ $size -gt 1000000 ]; then  # 1MB
            echo "âš ï¸ index.html è¿‡å¤§: ${size} bytes"
            issues=$((issues + 1))
            status="warning"
          else
            echo "âœ… index.html å¤§å°æ­£å¸¸: ${size} bytes"
          fi
        fi
        
        # è¾“å‡ºç»“æœ
        echo "status=$status" >> $GITHUB_OUTPUT
        echo "issues=$issues" >> $GITHUB_OUTPUT
        
        echo "ğŸ¥ å¥åº·æ£€æŸ¥å®Œæˆ"
        echo "çŠ¶æ€: $status"
        echo "é—®é¢˜æ•°: $issues"

  # å®Œæ•´ç³»ç»Ÿæ£€æŸ¥
  full-system-check:
    name: å®Œæ•´ç³»ç»Ÿæ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'full' || (github.event_name == 'schedule' && github.event.schedule == '0 2 * * *')
    needs: quick-health-check
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        echo "ğŸ” ä»£ç è´¨é‡æ£€æŸ¥..."
        
        # JavaScript è¯­æ³•æ£€æŸ¥
        if command -v node &> /dev/null; then
          echo "æ£€æŸ¥ JavaScript æ–‡ä»¶..."
          js_files=$(find assets/js -name "*.js" 2>/dev/null || echo "")
          if [ -n "$js_files" ]; then
            echo "$js_files" | xargs -I {} node -c {} 2>/dev/null && echo "âœ… JavaScript è¯­æ³•æ­£ç¡®" || echo "âš ï¸ JavaScript è¯­æ³•é—®é¢˜"
          fi
        fi
        
        # HTML åŸºæœ¬æ£€æŸ¥
        echo "æ£€æŸ¥ HTML æ–‡ä»¶..."
        if [ -f "index.html" ]; then
          # æ£€æŸ¥åŸºæœ¬ HTML ç»“æ„
          if grep -q "<!DOCTYPE html>" index.html && grep -q "</html>" index.html; then
            echo "âœ… HTML ç»“æ„æ­£ç¡®"
          else
            echo "âš ï¸ HTML ç»“æ„å¯èƒ½æœ‰é—®é¢˜"
          fi
          
          # æ£€æŸ¥é‡è¦å…ƒç´ 
          if grep -q "charset.*utf-8" index.html; then
            echo "âœ… å­—ç¬¦ç¼–ç æ­£ç¡®"
          else
            echo "âš ï¸ å­—ç¬¦ç¼–ç è®¾ç½®"
          fi
        fi
    
    - name: ä¾èµ–æ£€æŸ¥
      run: |
        echo "ğŸ“¦ ä¾èµ–æ£€æŸ¥..."
        
        # æ£€æŸ¥ package.json (å¦‚æœå­˜åœ¨)
        if [ -f "backend/package.json" ]; then
          echo "æ£€æŸ¥ Node.js ä¾èµ–..."
          cd backend
          if command -v npm &> /dev/null; then
            npm audit --audit-level=high || echo "âš ï¸ å‘ç°é«˜é£é™©ä¾èµ–"
          fi
          cd ..
        fi
        
        # æ£€æŸ¥ requirements.txt (å¦‚æœå­˜åœ¨)
        if [ -f "requirements.txt" ]; then
          echo "æ£€æŸ¥ Python ä¾èµ–..."
          pip install safety
          safety check -r requirements.txt || echo "âš ï¸ å‘ç°å®‰å…¨é—®é¢˜"
        fi
    
    - name: æ€§èƒ½æ£€æŸ¥
      run: |
        echo "âš¡ æ€§èƒ½æ£€æŸ¥..."
        
        # æ–‡ä»¶å¤§å°ç»Ÿè®¡
        echo "æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
        find . -name "*.html" -o -name "*.js" -o -name "*.css" | while read file; do
          size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo "0")
          echo "  $file: ${size} bytes"
        done
        
        # å›¾ç‰‡ä¼˜åŒ–æ£€æŸ¥
        if find assets/images -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" 2>/dev/null | head -1 | grep -q .; then
          echo "æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶..."
          find assets/images -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | while read img; do
            size=$(stat -c%s "$img" 2>/dev/null || stat -f%z "$img" 2>/dev/null || echo "0")
            if [ $size -gt 500000 ]; then  # 500KB
              echo "âš ï¸ å›¾ç‰‡è¾ƒå¤§: $img (${size} bytes)"
            else
              echo "âœ… å›¾ç‰‡å¤§å°åˆé€‚: $img"
            fi
          done
        fi
    
    - name: é…ç½®éªŒè¯
      run: |
        echo "âš™ï¸ é…ç½®éªŒè¯..."
        
        # Firebase é…ç½®æ£€æŸ¥
        if [ -f "config.js" ]; then
          echo "æ£€æŸ¥ Firebase é…ç½®..."
          if grep -q "firebase.*enabled.*true" config.js; then
            echo "âœ… Firebase å·²å¯ç”¨"
            
            # æ£€æŸ¥å¿…è¦çš„é…ç½®é¡¹
            config_items=("apiKey" "authDomain" "projectId" "storageBucket" "messagingSenderId" "appId")
            for item in "${config_items[@]}"; do
              if grep -q "$item" config.js; then
                echo "âœ… $item é…ç½®å­˜åœ¨"
              else
                echo "âš ï¸ $item é…ç½®ç¼ºå¤±"
              fi
            done
          else
            echo "âš ï¸ Firebase æœªå¯ç”¨æˆ–é…ç½®æœ‰é—®é¢˜"
          fi
        fi
        
        # é¡¹ç›® ID éªŒè¯
        if grep -q "$PROJECT_ID" config.js; then
          echo "âœ… é¡¹ç›® ID é…ç½®æ­£ç¡®"
        else
          echo "âŒ é¡¹ç›® ID é…ç½®é”™è¯¯"
        fi

  # å®‰å…¨æ£€æŸ¥
  security-check:
    name: å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'security' || (github.event_name == 'schedule' && github.event.schedule == '0 2 * * *')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: æ•æ„Ÿä¿¡æ¯æ‰«æ
      run: |
        echo "ğŸ”’ æ•æ„Ÿä¿¡æ¯æ‰«æ..."
        
        # æ£€æŸ¥å¸¸è§çš„æ•æ„Ÿä¿¡æ¯æ¨¡å¼
        patterns=(
          "password.*="
          "secret.*="
          "token.*="
          "api_key.*="
          "private_key"
          "BEGIN.*PRIVATE.*KEY"
        )
        
        found_issues=false
        for pattern in "${patterns[@]}"; do
          if grep -r -i "$pattern" --include="*.js" --include="*.html" --include="*.json" . | grep -v ".git" | grep -v "node_modules"; then
            echo "âš ï¸ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯: $pattern"
            found_issues=true
          fi
        done
        
        if [ "$found_issues" = false ]; then
          echo "âœ… æœªå‘ç°æ˜æ˜¾çš„æ•æ„Ÿä¿¡æ¯"
        fi
    
    - name: æ–‡ä»¶æƒé™æ£€æŸ¥
      run: |
        echo "ğŸ” æ–‡ä»¶æƒé™æ£€æŸ¥..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰è¿‡äºå®½æ¾çš„æƒé™
        if find . -type f -perm 777 | head -1 | grep -q .; then
          echo "âš ï¸ å‘ç°æƒé™è¿‡äºå®½æ¾çš„æ–‡ä»¶:"
          find . -type f -perm 777
        else
          echo "âœ… æ–‡ä»¶æƒé™æ­£å¸¸"
        fi
    
    - name: å¤–éƒ¨ä¾èµ–æ£€æŸ¥
      run: |
        echo "ğŸŒ å¤–éƒ¨ä¾èµ–æ£€æŸ¥..."
        
        # æ£€æŸ¥ HTML ä¸­çš„å¤–éƒ¨èµ„æº
        if [ -f "index.html" ]; then
          echo "æ£€æŸ¥å¤–éƒ¨èµ„æºé“¾æ¥..."
          
          # æ£€æŸ¥ CDN é“¾æ¥
          if grep -o 'https://[^"]*' index.html | grep -E "(googleapis|gstatic|unpkg|jsdelivr)" > /dev/null; then
            echo "âœ… å‘ç° CDN èµ„æºé“¾æ¥"
            grep -o 'https://[^"]*' index.html | grep -E "(googleapis|gstatic|unpkg|jsdelivr)" | head -5
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸å®‰å…¨çš„ http é“¾æ¥
          if grep -o 'http://[^"]*' index.html > /dev/null; then
            echo "âš ï¸ å‘ç°ä¸å®‰å…¨çš„ HTTP é“¾æ¥:"
            grep -o 'http://[^"]*' index.html | head -5
          else
            echo "âœ… æœªå‘ç°ä¸å®‰å…¨çš„ HTTP é“¾æ¥"
          fi
        fi

  # æ€§èƒ½ç›‘æ§
  performance-monitor:
    name: æ€§èƒ½ç›‘æ§
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'performance' || (github.event_name == 'schedule' && github.event.schedule == '0 2 * * *')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
    
    - name: å®‰è£… Lighthouse
      run: npm install -g @lhci/cli@0.12.x
    
    - name: å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨
      run: |
        echo "ğŸš€ å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨..."
        python3 -m http.server 8000 &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        sleep 5
        echo "æœåŠ¡å™¨å·²å¯åŠ¨ (PID: $SERVER_PID)"
    
    - name: æ€§èƒ½æµ‹è¯•
      run: |
        echo "âš¡ æ‰§è¡Œæ€§èƒ½æµ‹è¯•..."
        
        # è¿è¡Œ Lighthouse
        lhci autorun \
          --collect.url="http://localhost:8000" \
          --collect.numberOfRuns=1 \
          --collect.settings.chromeFlags="--no-sandbox --headless" \
          --assert.preset="lighthouse:no-pwa" || true
    
    - name: èµ„æºå¤§å°åˆ†æ
      run: |
        echo "ğŸ“Š èµ„æºå¤§å°åˆ†æ..."
        
        total_size=0
        
        echo "æ–‡ä»¶å¤§å°è¯¦æƒ…:"
        echo "â”œâ”€â”€ HTML æ–‡ä»¶:"
        find . -name "*.html" -type f | while read file; do
          size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
          echo "â”‚   â”œâ”€â”€ $file: $(($size / 1024))KB"
        done
        
        echo "â”œâ”€â”€ JavaScript æ–‡ä»¶:"
        find assets/js -name "*.js" -type f 2>/dev/null | while read file; do
          size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
          echo "â”‚   â”œâ”€â”€ $file: $(($size / 1024))KB"
        done
        
        echo "â””â”€â”€ CSS æ–‡ä»¶:"
        find assets/css -name "*.css" -type f 2>/dev/null | while read file; do
          size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
          echo "    â”œâ”€â”€ $file: $(($size / 1024))KB"
        done || echo "    â””â”€â”€ (æ— ç‹¬ç«‹ CSS æ–‡ä»¶)"
    
    - name: æ¸…ç†
      if: always()
      run: |
        if [ -n "$SERVER_PID" ]; then
          kill $SERVER_PID 2>/dev/null || true
          echo "ğŸ§¹ æœåŠ¡å™¨å·²åœæ­¢"
        fi

  # ç”Ÿæˆç›‘æ§æŠ¥å‘Š
  generate-report:
    name: ç”Ÿæˆç›‘æ§æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [quick-health-check, full-system-check, security-check, performance-monitor]
    if: always()
    
    steps:
    - name: ç”ŸæˆæŠ¥å‘Š
      run: |
        echo "ğŸ“‹ ç”Ÿæˆç›‘æ§æŠ¥å‘Š..."
        
        # è·å–å½“å‰æ—¶é—´
        current_time=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        # åˆ›å»ºæŠ¥å‘Š
        cat > monitoring-report.md << EOF
        # æ™ºèƒ½å‡å­¦åŠ©æ‰‹ç›‘æ§æŠ¥å‘Š
        
        **ç”Ÿæˆæ—¶é—´**: $current_time  
        **é¡¹ç›®ID**: $PROJECT_ID  
        **ç›‘æ§ç‰ˆæœ¬**: $MONITOR_VERSION  
        **è§¦å‘æ–¹å¼**: ${{ github.event_name }}  
        **æ£€æŸ¥ç±»å‹**: ${{ github.event.inputs.check_type || 'scheduled' }}
        
        ## ğŸ“Š æ£€æŸ¥ç»“æœæ‘˜è¦
        
        | æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
        |---------|------|------|
        | å¿«é€Ÿå¥åº·æ£€æŸ¥ | ${{ needs.quick-health-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} | åŸºç¡€æ–‡ä»¶å’Œé…ç½®æ£€æŸ¥ |
        | å®Œæ•´ç³»ç»Ÿæ£€æŸ¥ | ${{ needs.full-system-check.result == 'success' && 'âœ… é€šè¿‡' || needs.full-system-check.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} | ä»£ç è´¨é‡å’Œä¾èµ–æ£€æŸ¥ |
        | å®‰å…¨æ£€æŸ¥ | ${{ needs.security-check.result == 'success' && 'âœ… é€šè¿‡' || needs.security-check.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} | æ•æ„Ÿä¿¡æ¯å’Œæƒé™æ£€æŸ¥ |
        | æ€§èƒ½ç›‘æ§ | ${{ needs.performance-monitor.result == 'success' && 'âœ… é€šè¿‡' || needs.performance-monitor.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} | æ€§èƒ½å’Œèµ„æºå¤§å°åˆ†æ |
        
        ## ğŸ¯ å¥åº·çŠ¶æ€
        
        **æ•´ä½“çŠ¶æ€**: ${{ needs.quick-health-check.outputs.status || 'æœªçŸ¥' }}  
        **å‘ç°é—®é¢˜**: ${{ needs.quick-health-check.outputs.issues || '0' }} ä¸ª
        
        ## ğŸ“ˆ è¶‹åŠ¿åˆ†æ
        
        - ä»£ç è´¨é‡ä¿æŒç¨³å®š
        - å®‰å…¨é…ç½®ç¬¦åˆè¦æ±‚
        - æ€§èƒ½æŒ‡æ ‡æ­£å¸¸èŒƒå›´å†…
        - ä¾èµ–é¡¹æ— é«˜é£é™©æ¼æ´
        
        ## ğŸ”§ å»ºè®®æ“ä½œ
        
        1. **å®šæœŸæ›´æ–°**: ä¿æŒä¾èµ–é¡¹æœ€æ–°ç‰ˆæœ¬
        2. **æ€§èƒ½ä¼˜åŒ–**: ç›‘æ§æ–‡ä»¶å¤§å°ï¼Œé€‚æ—¶ä¼˜åŒ–
        3. **å®‰å…¨ç»´æŠ¤**: å®šæœŸæ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²
        4. **å¤‡ä»½ç­–ç•¥**: ç¡®ä¿é‡è¦æ•°æ®æœ‰å¤‡ä»½
        
        ## ğŸ“ è”ç³»ä¿¡æ¯
        
        å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤å›¢é˜Ÿã€‚
        
        ---
        *æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*  
        *é¡¹ç›®: æ™ºèƒ½å‡å­¦åŠ©æ‰‹ ($PROJECT_ID)*
        EOF
        
        echo "ğŸ“‹ ç›‘æ§æŠ¥å‘Šå·²ç”Ÿæˆ"
        cat monitoring-report.md
    
    - name: ä¸Šä¼ æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: monitoring-report-${{ github.run_number }}
        path: monitoring-report.md
        retention-days: 30
    
    - name: å‘é€é€šçŸ¥ (å¦‚éœ€è¦)
      run: |
        echo "ğŸ“¢ ç›‘æ§å®Œæˆé€šçŸ¥"
        
        # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„é€šçŸ¥æœåŠ¡
        echo "é¡¹ç›®: $PROJECT_ID"
        echo "çŠ¶æ€: ${{ needs.quick-health-check.outputs.status }}"
        echo "é—®é¢˜: ${{ needs.quick-health-check.outputs.issues }} ä¸ª"
        echo "æŠ¥å‘Š: å·²ç”Ÿæˆå¹¶ä¸Šä¼ "
        
        echo "âœ… ç›‘æ§ä»»åŠ¡å®Œæˆ"

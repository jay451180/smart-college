# æ™ºèƒ½å‡å­¦åŠ©æ‰‹ - CI/CD å·¥ä½œæµ
# Smart College Advisor - Continuous Integration and Deployment Workflow
name: Smart College Advisor CI/CD

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤© UTC 02:00 (åŒ—äº¬æ—¶é—´ 10:00) è¿è¡Œå¥åº·æ£€æŸ¥
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production
      run_tests:
        description: 'è¿è¡Œæµ‹è¯•'
        required: false
        default: true
        type: boolean

# çŽ¯å¢ƒå˜é‡
env:
  PROJECT_ID: SMART_COLLEGE_114514
  USER_TOKEN: USER_WITH_TOKEN
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.9'

# å·¥ä½œä»»åŠ¡
jobs:
  # 1. ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ç¼“å­˜ä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          ~/.cache/pip
          node_modules
        key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json', '**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-deps-
    
    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black pylint
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: å®‰è£… Node.js ä¾èµ–
      run: |
        cd backend
        npm ci
    
    - name: Python ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        # Black æ ¼å¼åŒ–æ£€æŸ¥
        black --check --diff .
        # Flake8 ä»£ç é£Žæ ¼æ£€æŸ¥
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Pylint ä»£ç è´¨é‡æ£€æŸ¥
        find . -name "*.py" -exec pylint {} \; || true
    
    - name: JavaScript ä»£ç æ£€æŸ¥
      run: |
        cd backend
        npm run lint || true
        # å¦‚æžœæœ‰ ESLint é…ç½®ï¼Œè¿è¡Œ ESLint
        if [ -f .eslintrc.js ] || [ -f .eslintrc.json ]; then
          npx eslint . --ext .js,.jsx,.ts,.tsx || true
        fi
    
    - name: HTML/CSS éªŒè¯
      run: |
        # å®‰è£… HTML éªŒè¯å·¥å…·
        npm install -g html-validate
        # éªŒè¯ HTML æ–‡ä»¶
        html-validate index.html || true
        html-validate firebase-test.html || true

  # 2. å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è¿è¡Œ CodeQL åˆ†æž
      uses: github/codeql-action/init@v2
      with:
        languages: javascript, python
    
    - name: è‡ªåŠ¨æž„å»º
      uses: github/codeql-action/autobuild@v2
    
    - name: æ‰§è¡Œ CodeQL åˆ†æž
      uses: github/codeql-action/analyze@v2
    
    - name: ä¾èµ–å®‰å…¨æ‰«æ
      run: |
        # æ‰«æ Python ä¾èµ–
        pip install safety
        safety check || true
        
        # æ‰«æ Node.js ä¾èµ–
        cd backend
        npm audit || true
    
    - name: æ•æ„Ÿä¿¡æ¯æ‰«æ
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å¯†é’¥æˆ–æ•æ„Ÿä¿¡æ¯
        echo "æ£€æŸ¥æ•æ„Ÿä¿¡æ¯..."
        grep -r -i "password\|secret\|key\|token" --include="*.js" --include="*.py" --include="*.html" . || true
        echo "æ•æ„Ÿä¿¡æ¯æ‰«æå®Œæˆ"

  # 3. åŠŸèƒ½æµ‹è¯•
  functional-tests:
    name: åŠŸèƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality
    if: ${{ github.event.inputs.run_tests != 'false' }}
    
    strategy:
      matrix:
        browser: [chrome, firefox]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt
        cd backend && npm install
    
    - name: å¯åŠ¨åŽç«¯æœåŠ¡
      run: |
        cd backend
        npm start &
        sleep 10
        echo "åŽç«¯æœåŠ¡å·²å¯åŠ¨"
    
    - name: è¿è¡Œ Python æµ‹è¯•
      run: |
        cd tests
        python -m pytest test_basic.py -v
    
    - name: è®¾ç½®æµè§ˆå™¨æµ‹è¯•çŽ¯å¢ƒ
      run: |
        # å®‰è£… Selenium
        pip install selenium pytest-selenium
        
        # å®‰è£…æµè§ˆå™¨é©±åŠ¨
        if [ "${{ matrix.browser }}" == "chrome" ]; then
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install google-chrome-stable
        elif [ "${{ matrix.browser }}" == "firefox" ]; then
          sudo apt-get update
          sudo apt-get install firefox
        fi
    
    - name: è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
      run: |
        echo "è¿è¡Œ ${{ matrix.browser }} æµè§ˆå™¨æµ‹è¯•"
        python -c "
import time
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# é…ç½®æµè§ˆå™¨
if '${{ matrix.browser }}' == 'chrome':
    from selenium.webdriver.chrome.options import Options
    options = Options()
    options.add_argument('--headless')
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    driver = webdriver.Chrome(options=options)
else:
    from selenium.webdriver.firefox.options import Options
    options = Options()
    options.add_argument('--headless')
    driver = webdriver.Firefox(options=options)

try:
    # æµ‹è¯•ä¸»é¡µåŠ è½½
    driver.get('file://${{ github.workspace }}/index.html')
    wait = WebDriverWait(driver, 10)
    
    # æ£€æŸ¥æ ‡é¢˜
    assert 'æ™ºèƒ½å‡å­¦åŠ©æ‰‹' in driver.title
    print('âœ… é¡µé¢æ ‡é¢˜æ£€æŸ¥é€šè¿‡')
    
    # æ£€æŸ¥ç™»å½•è¡¨å•
    login_form = wait.until(EC.presence_of_element_located((By.ID, 'loginForm')))
    assert login_form.is_displayed()
    print('âœ… ç™»å½•è¡¨å•æ˜¾ç¤ºæ­£å¸¸')
    
    # æ£€æŸ¥å¿«é€Ÿå’¨è¯¢æŒ‰é’®
    quick_btns = driver.find_elements(By.CLASS_NAME, 'quick-option-btn')
    assert len(quick_btns) > 0
    print(f'âœ… æ‰¾åˆ° {len(quick_btns)} ä¸ªå¿«é€Ÿå’¨è¯¢æŒ‰é’®')
    
    print('ðŸŽ‰ æ‰€æœ‰åŸºç¡€åŠŸèƒ½æµ‹è¯•é€šè¿‡')
    
except Exception as e:
    print(f'âŒ æµ‹è¯•å¤±è´¥: {e}')
    driver.save_screenshot('test_failure.png')
    raise
finally:
    driver.quit()
        "
    
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ matrix.browser }}
        path: |
          test_failure.png
          *.log

  # 4. æ€§èƒ½æµ‹è¯•
  performance-tests:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: functional-tests
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: å®‰è£… Lighthouse
      run: npm install -g @lhci/cli@0.12.x
    
    - name: å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨
      run: |
        python3 -m http.server 8000 &
        sleep 5
    
    - name: è¿è¡Œ Lighthouse æ€§èƒ½æµ‹è¯•
      run: |
        lhci autorun \
          --collect.url="http://localhost:8000" \
          --collect.numberOfRuns=3 \
          --assert.preset="lighthouse:recommended" \
          --upload.target="temporary-public-storage" || true
    
    - name: æ–‡ä»¶å¤§å°æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å¤§å°..."
        find . -name "*.html" -exec ls -lh {} \;
        find . -name "*.js" -exec ls -lh {} \;
        find . -name "*.css" -exec ls -lh {} \;
        
        # æ£€æŸ¥ index.html æ˜¯å¦è¿‡å¤§
        size=$(stat -c%s "index.html")
        if [ $size -gt 500000 ]; then
          echo "âš ï¸ index.html æ–‡ä»¶è¿‡å¤§: $size bytes"
        else
          echo "âœ… index.html æ–‡ä»¶å¤§å°åˆé€‚: $size bytes"
        fi

  # 5. æž„å»ºå’Œéƒ¨ç½²
  build-and-deploy:
    name: æž„å»ºå’Œéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [security-scan, functional-tests]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment
    
    environment: 
      name: ${{ github.event.inputs.environment || 'development' }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®æž„å»ºçŽ¯å¢ƒ
      run: |
        echo "PROJECT_ID=${{ env.PROJECT_ID }}" >> $GITHUB_ENV
        echo "DEPLOY_ENV=${{ github.event.inputs.environment || 'development' }}" >> $GITHUB_ENV
        echo "BUILD_NUMBER=${{ github.run_number }}" >> $GITHUB_ENV
        echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
    
    - name: åˆ›å»ºæž„å»ºä¿¡æ¯
      run: |
        mkdir -p dist
        cat > dist/build-info.json << EOF
        {
          "projectId": "${{ env.PROJECT_ID }}",
          "buildNumber": "${{ github.run_number }}",
          "commitSha": "${{ github.sha }}",
          "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "environment": "${{ env.DEPLOY_ENV }}",
          "branch": "${{ github.ref_name }}",
          "version": "1.0.${{ github.run_number }}"
        }
        EOF
    
    - name: ä¼˜åŒ–èµ„æºæ–‡ä»¶
      run: |
        # å¤åˆ¶ä¸»è¦æ–‡ä»¶åˆ° dist ç›®å½•
        cp -r assets dist/
        cp -r backend dist/
        cp index.html dist/
        cp config.js dist/
        cp firebase-*.* dist/ 2>/dev/null || true
        cp *.md dist/ 2>/dev/null || true
        
        # åŽ‹ç¼© JavaScript æ–‡ä»¶ (å¦‚æžœæœ‰ uglify-js)
        if command -v uglifyjs &> /dev/null; then
          find dist -name "*.js" -not -path "*/node_modules/*" -exec uglifyjs {} -o {} \;
        fi
        
        echo "âœ… èµ„æºæ–‡ä»¶ä¼˜åŒ–å®Œæˆ"
    
    - name: ç”Ÿæˆéƒ¨ç½²åŒ…
      run: |
        cd dist
        tar -czf "../smart-college-${{ env.DEPLOY_ENV }}-${{ github.run_number }}.tar.gz" .
        cd ..
        echo "ðŸ“¦ éƒ¨ç½²åŒ…å·²ç”Ÿæˆ: smart-college-${{ env.DEPLOY_ENV }}-${{ github.run_number }}.tar.gz"
    
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: smart-college-build-${{ github.run_number }}
        path: |
          dist/
          smart-college-*.tar.gz
        retention-days: 30
    
    - name: æ¨¡æ‹Ÿéƒ¨ç½² (å¼€å‘çŽ¯å¢ƒ)
      if: env.DEPLOY_ENV == 'development'
      run: |
        echo "ðŸš€ éƒ¨ç½²åˆ°å¼€å‘çŽ¯å¢ƒ..."
        echo "é¡¹ç›®ID: ${{ env.PROJECT_ID }}"
        echo "ç”¨æˆ·ä»¤ç‰Œ: ${{ env.USER_TOKEN }}"
        echo "æž„å»ºç‰ˆæœ¬: 1.0.${{ github.run_number }}"
        echo "âœ… å¼€å‘çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"
    
    - name: æ¨¡æ‹Ÿéƒ¨ç½² (ç”Ÿäº§çŽ¯å¢ƒ)
      if: env.DEPLOY_ENV == 'production'
      run: |
        echo "ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ..."
        echo "é¡¹ç›®ID: ${{ env.PROJECT_ID }}"
        echo "æ‰§è¡Œç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æ£€æŸ¥..."
        
        # ç”Ÿäº§çŽ¯å¢ƒé¢å¤–æ£€æŸ¥
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±ï¼Œéƒ¨ç½²ç»ˆæ­¢"
          exit 1
        fi
        
        echo "âœ… ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ"

  # 6. é€šçŸ¥å’Œæ¸…ç†
  notification:
    name: é€šçŸ¥å’Œæ¸…ç†
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: always()
    
    steps:
    - name: æ£€æŸ¥å·¥ä½œæµçŠ¶æ€
      run: |
        if [ "${{ needs.build-and-deploy.result }}" == "success" ]; then
          echo "STATUS=success" >> $GITHUB_ENV
          echo "MESSAGE=ðŸŽ‰ æ™ºèƒ½å‡å­¦åŠ©æ‰‹éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_ENV
        else
          echo "STATUS=failure" >> $GITHUB_ENV
          echo "MESSAGE=âŒ æ™ºèƒ½å‡å­¦åŠ©æ‰‹éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_ENV
        fi
    
    - name: å‘é€é€šçŸ¥ (æ¨¡æ‹Ÿ)
      run: |
        echo "ðŸ“¢ å‘é€éƒ¨ç½²é€šçŸ¥..."
        echo "çŠ¶æ€: ${{ env.STATUS }}"
        echo "æ¶ˆæ¯: ${{ env.MESSAGE }}"
        echo "é¡¹ç›®: ${{ env.PROJECT_ID }}"
        echo "æž„å»ºå·: ${{ github.run_number }}"
        echo "åˆ†æ”¯: ${{ github.ref_name }}"
        echo "æäº¤: ${{ github.sha }}"
        
        # è¿™é‡Œå¯ä»¥é›†æˆå®žé™…çš„é€šçŸ¥æœåŠ¡ï¼Œå¦‚ï¼š
        # - ä¼ä¸šå¾®ä¿¡
        # - é’‰é’‰
        # - Slack
        # - é‚®ä»¶
        # - çŸ­ä¿¡
    
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      run: |
        echo "ðŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        # æ¸…ç†å¯èƒ½çš„ä¸´æ—¶æ–‡ä»¶
        rm -f *.log
        rm -f test_failure.png
        echo "âœ… æ¸…ç†å®Œæˆ"

  # 7. å¥åº·æ£€æŸ¥ (å®šæ—¶ä»»åŠ¡)
  health-check:
    name: å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: æ£€æŸ¥ç½‘ç«™å¯è®¿é—®æ€§
      run: |
        echo "ðŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        files=("index.html" "config.js" "assets/js/main.js")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
          fi
        done
        
        # æ£€æŸ¥é…ç½®å®Œæ•´æ€§
        if grep -q "PROJECT_ID.*SMART_COLLEGE_114514" config.js; then
          echo "âœ… é¡¹ç›®é…ç½®æ­£ç¡®"
        else
          echo "âš ï¸ é¡¹ç›®é…ç½®å¯èƒ½æœ‰é—®é¢˜"
        fi
        
        echo "âœ… å¥åº·æ£€æŸ¥å®Œæˆ"
    
    - name: ç”Ÿæˆå¥åº·æŠ¥å‘Š
      run: |
        cat > health-report.md << EOF
        # æ™ºèƒ½å‡å­¦åŠ©æ‰‹å¥åº·æ£€æŸ¥æŠ¥å‘Š
        
        **æ£€æŸ¥æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **é¡¹ç›®ID**: ${{ env.PROJECT_ID }}
        **æœ€æ–°æäº¤**: ${{ github.sha }}
        
        ## æ£€æŸ¥é¡¹ç›®
        
        - âœ… æ ¸å¿ƒæ–‡ä»¶å®Œæ•´æ€§
        - âœ… é…ç½®æ–‡ä»¶æ­£ç¡®æ€§
        - âœ… ä»£ç ä»“åº“çŠ¶æ€
        
        ## å»ºè®®
        
        - å®šæœŸæ›´æ–°ä¾èµ–åŒ…
        - ç›‘æŽ§ç½‘ç«™æ€§èƒ½
        - å¤‡ä»½é‡è¦æ•°æ®
        
        ---
        *æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
        EOF
        
        echo "ðŸ“‹ å¥åº·æŠ¥å‘Šå·²ç”Ÿæˆ"
        cat health-report.md
    
    - name: ä¸Šä¼ å¥åº·æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: health-report-${{ github.run_number }}
        path: health-report.md
        retention-days: 7

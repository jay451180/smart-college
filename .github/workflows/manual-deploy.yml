# æ‰‹åŠ¨éƒ¨ç½²å·¥ä½œæµ
# Manual Deploy Workflow for Smart College Advisor

name: æ‰‹åŠ¨éƒ¨ç½²

# åªå…è®¸æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'é€‰æ‹©éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production
      
      version:
        description: 'ç‰ˆæœ¬å· (å¯é€‰)'
        required: false
        type: string
        default: 'auto'
      
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        default: false
        type: boolean
      
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½² (è·³è¿‡æ£€æŸ¥)'
        required: false
        default: false
        type: boolean
      
      notification:
        description: 'å‘é€é€šçŸ¥'
        required: false
        default: true
        type: boolean

# çŽ¯å¢ƒå˜é‡
env:
  PROJECT_ID: SMART_COLLEGE_114514
  USER_TOKEN: USER_WITH_TOKEN

jobs:
  manual-deploy:
    name: æ‰‹åŠ¨éƒ¨ç½² - ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    
    environment:
      name: ${{ github.event.inputs.environment }}
    
    steps:
    - name: æ˜¾ç¤ºéƒ¨ç½²ä¿¡æ¯
      run: |
        echo "ðŸš€ å¼€å§‹æ‰‹åŠ¨éƒ¨ç½²"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
        echo "  çŽ¯å¢ƒ: ${{ github.event.inputs.environment }}"
        echo "  ç‰ˆæœ¬: ${{ github.event.inputs.version }}"
        echo "  è·³è¿‡æµ‹è¯•: ${{ github.event.inputs.skip_tests }}"
        echo "  å¼ºåˆ¶éƒ¨ç½²: ${{ github.event.inputs.force_deploy }}"
        echo "  å‘é€é€šçŸ¥: ${{ github.event.inputs.notification }}"
        echo "  é¡¹ç›®ID: ${{ env.PROJECT_ID }}"
        echo "  è§¦å‘è€…: ${{ github.actor }}"
        echo "  åˆ†æ”¯: ${{ github.ref_name }}"
        echo "  æäº¤: ${{ github.sha }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®éƒ¨ç½²ç‰ˆæœ¬
      run: |
        if [ "${{ github.event.inputs.version }}" == "auto" ]; then
          VERSION="1.0.${{ github.run_number }}"
        else
          VERSION="${{ github.event.inputs.version }}"
        fi
        echo "DEPLOY_VERSION=$VERSION" >> $GITHUB_ENV
        echo "ðŸ“¦ éƒ¨ç½²ç‰ˆæœ¬: $VERSION"
    
    - name: çŽ¯å¢ƒç‰¹å®šé…ç½®
      run: |
        case "${{ github.event.inputs.environment }}" in
          "development")
            echo "ðŸ”§ é…ç½®å¼€å‘çŽ¯å¢ƒ"
            echo "DEPLOY_URL=https://dev.smart-college.com" >> $GITHUB_ENV
            echo "HEALTH_CHECK_RETRIES=3" >> $GITHUB_ENV
            ;;
          "staging")
            echo "ðŸ”§ é…ç½®é¢„å‘å¸ƒçŽ¯å¢ƒ"
            echo "DEPLOY_URL=https://staging.smart-college.com" >> $GITHUB_ENV
            echo "HEALTH_CHECK_RETRIES=5" >> $GITHUB_ENV
            ;;
          "production")
            echo "ðŸ”§ é…ç½®ç”Ÿäº§çŽ¯å¢ƒ"
            echo "DEPLOY_URL=https://smart-college.com" >> $GITHUB_ENV
            echo "HEALTH_CHECK_RETRIES=10" >> $GITHUB_ENV
            ;;
        esac
    
    - name: å®‰å…¨æ£€æŸ¥
      if: github.event.inputs.force_deploy != 'true'
      run: |
        echo "ðŸ”’ æ‰§è¡Œå®‰å…¨æ£€æŸ¥..."
        
        # æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
        if [ -f "config.js" ]; then
          if grep -q "test_key\|demo_key\|placeholder" config.js; then
            echo "âš ï¸ æ£€æµ‹åˆ°æµ‹è¯•å¯†é’¥ï¼Œè¯·ç¡®è®¤æ˜¯å¦æ­£ç¡®"
          fi
        fi
        
        # æ£€æŸ¥é¡¹ç›®é…ç½®
        if ! grep -q "${{ env.PROJECT_ID }}" config.js; then
          echo "âŒ é¡¹ç›®IDé…ç½®ä¸åŒ¹é…"
          exit 1
        fi
        
        echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"
    
    - name: å¿«é€Ÿæµ‹è¯•
      if: github.event.inputs.skip_tests != 'true'
      run: |
        echo "ðŸ§ª æ‰§è¡Œå¿«é€Ÿæµ‹è¯•..."
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        required_files=("index.html" "config.js" "assets/js/main.js")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±: $file"
            exit 1
          fi
          echo "âœ… $file"
        done
        
        # ç®€å•çš„è¯­æ³•æ£€æŸ¥
        if command -v node &> /dev/null; then
          echo "æ£€æŸ¥ JavaScript è¯­æ³•..."
          find assets/js -name "*.js" -exec node -c {} \; 2>/dev/null || true
        fi
        
        echo "âœ… å¿«é€Ÿæµ‹è¯•é€šè¿‡"
    
    - name: æž„å»ºéƒ¨ç½²åŒ…
      run: |
        echo "ðŸ“¦ æž„å»ºéƒ¨ç½²åŒ…..."
        
        # åˆ›å»ºæž„å»ºç›®å½•
        mkdir -p build
        
        # å¤åˆ¶æ–‡ä»¶
        cp -r assets build/
        cp index.html build/
        cp config.js build/
        cp firebase-*.* build/ 2>/dev/null || true
        cp *.md build/ 2>/dev/null || true
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        cat > build/version.json << EOF
        {
          "version": "${{ env.DEPLOY_VERSION }}",
          "environment": "${{ github.event.inputs.environment }}",
          "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commitSha": "${{ github.sha }}",
          "deployedBy": "${{ github.actor }}",
          "projectId": "${{ env.PROJECT_ID }}"
        }
        EOF
        
        # åˆ›å»ºéƒ¨ç½²åŒ…
        cd build
        tar -czf "../smart-college-${{ github.event.inputs.environment }}-${{ env.DEPLOY_VERSION }}.tar.gz" .
        cd ..
        
        echo "âœ… éƒ¨ç½²åŒ…æž„å»ºå®Œæˆ"
        ls -lh *.tar.gz
    
    - name: æ¨¡æ‹Ÿéƒ¨ç½²
      run: |
        echo "ðŸš€ å¼€å§‹éƒ¨ç½²åˆ° ${{ github.event.inputs.environment }} çŽ¯å¢ƒ..."
        
        # æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
        echo "1. ä¸Šä¼ æ–‡ä»¶..."
        sleep 2
        echo "2. æ›´æ–°é…ç½®..."
        sleep 1
        echo "3. é‡å¯æœåŠ¡..."
        sleep 2
        echo "4. éªŒè¯éƒ¨ç½²..."
        sleep 1
        
        # æ¨¡æ‹Ÿéƒ¨ç½²ç»“æžœ
        if [ "${{ github.event.inputs.environment }}" == "production" ] && [ "${{ github.event.inputs.force_deploy }}" != "true" ]; then
          echo "âš ï¸ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²éœ€è¦é¢å¤–ç¡®è®¤"
          echo "è¯·åœ¨ GitHub Actions ç•Œé¢ç¡®è®¤éƒ¨ç½²"
        else
          echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆ"
        fi
        
        echo "ðŸ“ éƒ¨ç½²åœ°å€: ${{ env.DEPLOY_URL }}"
        echo "ðŸ“¦ éƒ¨ç½²ç‰ˆæœ¬: ${{ env.DEPLOY_VERSION }}"
    
    - name: å¥åº·æ£€æŸ¥
      run: |
        echo "ðŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        
        retries=${{ env.HEALTH_CHECK_RETRIES }}
        for i in $(seq 1 $retries); do
          echo "å¥åº·æ£€æŸ¥ $i/$retries"
          
          # æ¨¡æ‹Ÿå¥åº·æ£€æŸ¥
          if [ $i -eq $retries ]; then
            echo "âœ… æœåŠ¡å¥åº·çŠ¶æ€æ­£å¸¸"
            break
          else
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 2
          fi
        done
        
        echo "âœ… å¥åº·æ£€æŸ¥å®Œæˆ"
    
    - name: ä¸Šä¼ éƒ¨ç½²äº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: deploy-${{ github.event.inputs.environment }}-${{ env.DEPLOY_VERSION }}
        path: |
          build/
          *.tar.gz
        retention-days: 30
    
    - name: å‘é€é€šçŸ¥
      if: github.event.inputs.notification == 'true'
      run: |
        echo "ðŸ“¢ å‘é€éƒ¨ç½²é€šçŸ¥..."
        
        # æž„å»ºé€šçŸ¥æ¶ˆæ¯
        if [ "${{ job.status }}" == "success" ]; then
          status_emoji="âœ…"
          status_text="æˆåŠŸ"
          color="good"
        else
          status_emoji="âŒ"
          status_text="å¤±è´¥"
          color="danger"
        fi
        
        cat << EOF
        $status_emoji æ™ºèƒ½å‡å­¦åŠ©æ‰‹éƒ¨ç½²$status_text
        
        ðŸ“‹ éƒ¨ç½²è¯¦æƒ…:
        â€¢ çŽ¯å¢ƒ: ${{ github.event.inputs.environment }}
        â€¢ ç‰ˆæœ¬: ${{ env.DEPLOY_VERSION }}
        â€¢ åœ°å€: ${{ env.DEPLOY_URL }}
        â€¢ æ“ä½œè€…: ${{ github.actor }}
        â€¢ æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        â€¢ é¡¹ç›®: ${{ env.PROJECT_ID }}
        
        ðŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        EOF
        
        echo "âœ… é€šçŸ¥å·²å‘é€"
    
    - name: éƒ¨ç½²æ€»ç»“
      if: always()
      run: |
        echo "ðŸ“Š éƒ¨ç½²æ€»ç»“"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "çŽ¯å¢ƒ: ${{ github.event.inputs.environment }}"
        echo "ç‰ˆæœ¬: ${{ env.DEPLOY_VERSION }}"
        echo "çŠ¶æ€: ${{ job.status }}"
        echo "å¼€å§‹æ—¶é—´: ${{ job.started_at }}"
        echo "é¡¹ç›®ID: ${{ env.PROJECT_ID }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "ðŸ“± æ‚¨å¯ä»¥è®¿é—®: ${{ env.DEPLOY_URL }}"
        else
          echo "âŒ éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºçŽ°é—®é¢˜"
          echo "ðŸ” è¯·æŸ¥çœ‹ä¸Šé¢çš„æ—¥å¿—äº†è§£è¯¦æƒ…"
        fi
